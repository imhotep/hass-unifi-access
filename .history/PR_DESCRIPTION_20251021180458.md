# Fix Unicode Handling and Dependency Requirements

## Problems Addressed

### 1. Unicode Door Name Matching Issue
The UniFi Access integration failed to detect doorbell events when device names contained German umlauts (Ã¶, Ã¤, Ã¼) or other special Unicode characters. Users reported that "The integration doesn't show anymore that someone has rang the doorbell" when their UniFi Access devices had German names.

**Root Cause:** Unicode characters can be represented in different normalization forms (NFC vs NFD). When door names from the API used one form and WebSocket events used another, the string matching failed, causing doorbell events to be ignored.

### 2. Dependency Installation Error
Newer Home Assistant versions showed the error: "Setup failed for custom integration 'unifi_access': Requirements for unifi_access not found: ['websocket-client==1.8.0']."

**Root Cause:** The exact version pinning (`==1.8.0`) prevented Home Assistant from using compatible newer versions of websocket-client, causing installation failures.

## Solution Implemented

### Changes Made in `custom_components/unifi_access/hub.py`:

1. **Added Unicode normalization function** (line ~58):
```python
def normalize_door_name(name):
    """Normalize door name to handle Unicode characters consistently."""
    if not name or not isinstance(name, str):
        return name
    return unicodedata.normalize('NFC', name.strip())
```

2. **Updated door storage** during initialization (line ~259):
- Normalize door names when storing them from the API
- Ensures consistent representation in internal storage

3. **Fixed WebSocket event matching** (line ~390):
- Normalize door names from incoming WebSocket events
- Enables reliable matching against stored door names

### Technical Details:
- Uses Unicode NFC (Canonical Composition) normalization
- Handles edge cases (None, empty strings, non-string types)
- Maintains full backward compatibility with ASCII door names
- Added proper import for `unicodedata` module

## Testing Performed

### Comprehensive Docker-based Testing:
- **Environment**: Python 3.11-slim Docker container (matches Home Assistant environment)
- **Test Coverage**: 
  - German door names: "TÃ¼rklingel", "BÃ¼ro TÃ¼r", "AuÃŸentÃ¼r"
  - Mixed Unicode forms (NFC vs NFD composition)
  - Edge cases: empty strings, whitespace, None values
  - ASCII compatibility verification

### Detailed Test Results with Code Proof:

**Docker Test Environment:** `python:3.11-slim` container  
**Command:** `docker run --rm -v $(pwd):/app -w /app python:3.11-slim python test_unicode.py`

**Test 1-3: German Umlaut Normalization**
```python
# Test code executed:
import unicodedata

def normalize_door_name(name):
    if not name or not isinstance(name, str):
        return name
    return unicodedata.normalize('NFC', name.strip())

# Test cases:
test_names = ["TÃ¼rklingel", "BÃ¼ro TÃ¼r", "AuÃŸentÃ¼r"]
for name in test_names:
    normalized = normalize_door_name(name)
    print(f"âœ… '{name}' â†’ '{normalized}' (NFC normalized)")
```
**Result:** All German umlauts normalized correctly to NFC form

**Test 4-6: Unicode Form Consistency**
```python
# Test NFD â†’ NFC conversion:
import unicodedata
nfd_name = unicodedata.normalize('NFD', "TÃ¼rklingel")  # Decomposed form
nfc_name = unicodedata.normalize('NFC', "TÃ¼rklingel")  # Composed form

# Verify they match after normalization:
assert normalize_door_name(nfd_name) == normalize_door_name(nfc_name)
print(f"âœ… NFD '{nfd_name}' == NFC '{nfc_name}' after normalization")
```
**Result:** Different Unicode representations normalized to identical strings

**Test 7-9: Edge Case Handling**
```python
# Edge case tests:
edge_cases = [
    ("", "Empty string"),
    (None, "None value"), 
    ("  ", "Whitespace only"),
    ("  TÃ¼rklingel  ", "Whitespace + umlaut")
]

for test_input, description in edge_cases:
    result = normalize_door_name(test_input)
    print(f"âœ… {description}: {test_input!r} â†’ {result!r}")
```
**Result:** All edge cases handled safely without errors

**Test 10: ASCII Compatibility**  
```python
# ASCII door names should remain unchanged:
ascii_names = ["Front Door", "Back Gate", "Main Entrance"]
for name in ascii_names:
    normalized = normalize_door_name(name)
    assert normalized == name
    print(f"âœ… ASCII unchanged: '{name}' â†’ '{normalized}'")
```
**Result:** ASCII names unaffected, maintaining backward compatibility

**Syntax Validation:**
```bash
# Command executed in Docker:
docker run --rm -v $(pwd):/app -w /app python:3.11-slim python -m py_compile custom_components/unifi_access/hub.py
# Exit code: 0 (success, no syntax errors)
```

**Integration Test - Door Matching Logic:**
```python
# Simulated WebSocket matching test:
stored_doors = {"TÃ¼rklingel": {"id": "123"}}  # Stored as NFC
event_door_name = unicodedata.normalize('NFD', "TÃ¼rklingel")  # Event as NFD

# Original code would fail this match:
# if event_door_name in stored_doors:  # False - NFD != NFC

# Fixed code succeeds:
normalized_event_name = normalize_door_name(event_door_name)
if normalized_event_name in stored_doors:  # True - both NFC
    print(f"âœ… Door match successful: {normalized_event_name}")
```

**Docker Test Output:**
```
âœ… All tests PASSED! The Unicode fix works correctly.
ðŸŽ‰ All tests PASSED! Passed: 10, Failed: 0
```

**Total: 10/10 tests passed with documented proof**  

### Manual Verification:
- Tested door name normalization with real German device names
- Verified WebSocket matching logic with normalized names
- Confirmed no impact on existing ASCII door names

## Impact
- **German users** can now reliably receive doorbell notifications with device names containing Ã¶, Ã¤, Ã¼
- **International users** benefit from improved Unicode character support
- **No breaking changes** - existing installations continue to work unchanged
- **Improved reliability** for any special characters in door names

### Changes Made in `custom_components/unifi_access/manifest.json`:

1. **Fixed websocket-client dependency** (line 11):
- Changed from exact version `websocket-client==1.8.0` to minimum version `websocket-client>=1.8.0`
- Allows Home Assistant to use compatible newer versions (current latest: 1.9.0)
- Resolves installation failures in newer Home Assistant versions

2. **Updated integration version** to 1.3.3

## Files Modified
- `custom_components/unifi_access/hub.py`: Added Unicode normalization support
- `custom_components/unifi_access/manifest.json`: Fixed websocket-client dependency requirement