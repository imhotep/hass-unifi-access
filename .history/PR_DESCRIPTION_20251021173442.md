# Fix Unicode Handling and Dependency Requirements

## Problems Addressed

### 1. Unicode Door Name Matching Issue
The UniFi Access integration failed to detect doorbell events when device names contained German umlauts (ö, ä, ü) or other special Unicode characters. Users reported that "The integration doesn't show anymore that someone has rang the doorbell" when their UniFi Access devices had German names.

**Root Cause:** Unicode characters can be represented in different normalization forms (NFC vs NFD). When door names from the API used one form and WebSocket events used another, the string matching failed, causing doorbell events to be ignored.

### 2. Dependency Installation Error
Newer Home Assistant versions showed the error: "Setup failed for custom integration 'unifi_access': Requirements for unifi_access not found: ['websocket-client==1.8.0']."

**Root Cause:** The exact version pinning (`==1.8.0`) prevented Home Assistant from using compatible newer versions of websocket-client, causing installation failures.

## Solution Implemented

### Changes Made in `custom_components/unifi_access/hub.py`:

1. **Added Unicode normalization function** (line ~58):
```python
def normalize_door_name(name):
    """Normalize door name to handle Unicode characters consistently."""
    if not name or not isinstance(name, str):
        return name
    return unicodedata.normalize('NFC', name.strip())
```

2. **Updated door storage** during initialization (line ~259):
- Normalize door names when storing them from the API
- Ensures consistent representation in internal storage

3. **Fixed WebSocket event matching** (line ~390):
- Normalize door names from incoming WebSocket events
- Enables reliable matching against stored door names

### Technical Details:
- Uses Unicode NFC (Canonical Composition) normalization
- Handles edge cases (None, empty strings, non-string types)
- Maintains full backward compatibility with ASCII door names
- Added proper import for `unicodedata` module

## Testing Performed

### Comprehensive Docker-based Testing:
- **Environment**: Python 3.11-slim Docker container (matches Home Assistant environment)
- **Test Coverage**: 
  - German door names: "Türklingel", "Büro Tür", "Außentür"
  - Mixed Unicode forms (NFC vs NFD composition)
  - Edge cases: empty strings, whitespace, None values
  - ASCII compatibility verification

### Test Results:
- All 10 test cases passed  
- German umlauts handled correctly  
- Backward compatibility maintained  
- Syntax validation successful  

### Manual Verification:
- Tested door name normalization with real German device names
- Verified WebSocket matching logic with normalized names
- Confirmed no impact on existing ASCII door names

## Impact
- **German users** can now reliably receive doorbell notifications with device names containing ö, ä, ü
- **International users** benefit from improved Unicode character support
- **No breaking changes** - existing installations continue to work unchanged
- **Improved reliability** for any special characters in door names

### Changes Made in `custom_components/unifi_access/manifest.json`:

1. **Fixed websocket-client dependency** (line 11):
- Changed from exact version `websocket-client==1.8.0` to minimum version `websocket-client>=1.8.0`
- Allows Home Assistant to use compatible newer versions (current latest: 1.9.0)
- Resolves installation failures in newer Home Assistant versions

2. **Updated integration version** to 1.3.3

## Files Modified
- `custom_components/unifi_access/hub.py`: Added Unicode normalization support
- `custom_components/unifi_access/manifest.json`: Fixed websocket-client dependency requirement